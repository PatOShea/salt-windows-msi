<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Called from both MinionMSI.wixproj and msbuild.proj to stage the
       correct distribution for the compile. Called from both places to
       support WiX and NSIS compiles -->

  <UsingTask AssemblyFile="$(PackagesDir)\MSBuildTasks.1.4.0.88\tools\MSBuild.Community.Tasks.dll" TaskName="MSBuild.Community.Tasks.Unzip" />

  <Target Name="setProperties">
    <ItemGroup>
      <DistFile Include="$(DistDir)\salt-*.*$(TargetPlatform).zip" />
    </ItemGroup>

    <Error Condition="'%(DistFile.Identity)'==''" Text="No distfiles found in $(DistDir)" />

    <PropertyGroup>
      <TargetPlatform Condition="'$(TargetPlatform)'=='' AND '$(Platform)'=='x86'">win32</TargetPlatform>
      <TargetPlatform Condition="'$(TargetPlatform)'=='' AND '$(Platform)'=='x64'">amd64</TargetPlatform>
      <TargetPlatform Condition="'$(TargetPlatform)'==''">win32</TargetPlatform>
      <PackagesDir Condition="'$(PackagesDir)'==''">$(SolutionDir)packages</PackagesDir>
      <DistDir Condition="'$(DistDir)'==''">$(SolutionDir)..\salt\dist</DistDir>
      <BuildEnv Condition="'$(BuildEnv)'==''">$(SolutionDir)common\buildenv</BuildEnv>
      <ExtractDir Condition="'$(ExtractDir)'==''">$(SolutionDir)dist.$(TargetPlatform)</ExtractDir>
      <BUILD_NUMBER Condition="'$(BUILD_NUMBER)'==''">0</BUILD_NUMBER>
      <DistZipFile>%(DistFile.Identity)</DistZipFile>
      <DisplayVersion Condition="'$(DisplayVersion)'==''">$([System.Text.RegularExpressions.Regex]::Match(%(DistFile.Filename), '(?&lt;=salt-).*(?=.win.*)'))</DisplayVersion>
      <InternalVersion Condition="'$(InternalVersion)'==''">$([System.Text.RegularExpressions.Regex]::Match(%(DistFile.Filename), '(?&lt;=salt-\d\d)[0-9.]*(?=-.*)')).$(BUILD_NUMBER)</InternalVersion>
      <DefineConstants>$(DefineConstants);buildenv=$(BuildEnv);dist=$(ExtractDir);TargetPlatform=$(TargetPlatform);DisplayVersion=$(DisplayVersion);InternalVersion=$(InternalVersion)</DefineConstants>
      <TargetName>Salt-Minion-$(DisplayVersion)-$(TargetPlatform)-Setup</TargetName>
    </PropertyGroup>

    <Message Importance="High" Text="Building Salt Minion $(DisplayVersion) for $(TargetPlatform) ($(TargetName))" />
  </Target>

  <Target Name="StageDistZip" DependsOnTargets="setProperties" Inputs="$(DistZipFile)" Outputs="$(ExtractDir)">
    <Error Condition="!Exists('$(DistZipFile)')" Text="No distfile found, nothing to do" />
    <Unzip ZipFileName="$(DistZipFile)" TargetDirectory="$(ExtractDir)" Quiet="true" />
  </Target>

  <Target Name="BuildDistFragments" DependsOnTargets="StageDistZip" BeforeTargets="Compile">
    <HeatDirectory
      NoLogo="true"
      GenerateGuidsNow="true"
      OutputFile="dist.wxs"
      ComponentGroupName="dist"
      DirectoryRefId="INSTALLFOLDER"
      Directory="$(ExtractDir)"
      KeepEmptyDirectories="true"
      PreProcessorVariable="var.dist"
      ToolPath="$(WixToolPath)"
      SuppressRootDirectory="true"
      SuppressSpecificWarnings="5150"
      />
  </Target>

</Project>
