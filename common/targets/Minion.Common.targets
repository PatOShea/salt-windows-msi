<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Called from both MinionMSI.wixproj and msbuild.proj to stage the
       correct distribution for the compile. Called from both places to
       support WiX and NSIS compiles -->

  <UsingTask AssemblyFile="$(PackagesDir)\MSBuildTasks.1.4.0.88\tools\MSBuild.Community.Tasks.dll" TaskName="MSBuild.Community.Tasks.Unzip" />

  <ItemGroup>
    <BuildEnvContent Include="$(BuildEnv)\**\*.*" />
  </ItemGroup>

  <Target Name="setProperties">
    <PropertyGroup>
      <TargetPlatform Condition="'$(TargetPlatform)'=='' AND '$(Platform)'=='x86'">win32</TargetPlatform>
      <TargetPlatform Condition="'$(TargetPlatform)'=='' AND '$(Platform)'=='x64'">amd64</TargetPlatform>
      <PackagesDir Condition="'$(PackagesDir)'==''">$(MSBuildProjectDirectory)\..\..\packages</PackagesDir>
      <DistDir Condition="'$(DistDir)'==''">$(MSBuildProjectDirectory)\..\..\..\salt\dist</DistDir>
      <BuildEnv Condition="'$(BuildEnv)'==''">$(MSBuildProjectDirectory)\..\..\common\buildenv</BuildEnv>
      <ExtractDir Condition="'$(ExtractDir)'==''">$(MSBuildProjectDirectory)\..\..\dist.$(TargetPlatform)</ExtractDir>
      <BUILD_NUMBER Condition="'$(BUILD_NUMBER)'==''">0</BUILD_NUMBER>
    </PropertyGroup>

    <ItemGroup>
      <DistFile Include="$(DistDir)\salt-*.*$(TargetPlatform).zip" />
    </ItemGroup>

    <Error Condition="'%(DistFile.Identity)'==''" Text="No distfiles for $(TargetPlatform) found in $(DistDir)" />

    <PropertyGroup>
      <DistZipFile>%(DistFile.Identity)</DistZipFile>
      <DisplayVersion Condition="'$(DisplayVersion)'==''">$([System.Text.RegularExpressions.Regex]::Match(%(DistFile.Filename), '(?&lt;=salt-).*(?=.win.*)'))</DisplayVersion>
      <InternalVersion Condition="'$(InternalVersion)'==''">$([System.Text.RegularExpressions.Regex]::Match(%(DistFile.Filename), '(?&lt;=salt-\d\d)[0-9.]*(?=-.*)')).$(BUILD_NUMBER)</InternalVersion>
      <DefineConstants>$(DefineConstants);buildenv=$(BuildEnv);dist=$(ExtractDir);TargetPlatform=$(TargetPlatform);DisplayVersion=$(DisplayVersion);InternalVersion=$(InternalVersion)</DefineConstants>
      <TargetName>Salt-Minion-$(DisplayVersion)-$(TargetPlatform)-Setup</TargetName>
    </PropertyGroup>

    <Message Importance="High" Text="Building Salt Minion $(DisplayVersion) for $(TargetPlatform) ($(TargetName))" />
  </Target>

  <Target Name="StageDistZip" DependsOnTargets="setProperties" Inputs="$(DistZipFile)" Outputs="$(ExtractDir)">
    <Error Condition="!Exists('$(DistZipFile)')" Text="No distfile found, nothing to do" />
    <Unzip ZipFileName="$(DistZipFile)" TargetDirectory="$(ExtractDir)" Quiet="true" />
  </Target>

  <Target Name="DistContent" DependsOnTargets="StageDistZip" Outputs="@(DistContent)">
    <ItemGroup>
      <DistContent Include="$(ExtractDir)\**\*.*" />
    </ItemGroup>
  </Target>

</Project>
